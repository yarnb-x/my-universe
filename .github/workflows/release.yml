name: Release - ç‰ˆæœ¬å‘å¸ƒ

on:
  push:
    tags:
      - 'v*.*.*'

# æ·»åŠ æƒé™é…ç½®ï¼Œå…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ„å»ºäº§ç‰©
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶
  packages: read   # å…è®¸è¯»å–åŒ…

env:
  CARGO_TERM_COLOR: always

jobs:
  # å‘å¸ƒå‰æ£€æŸ¥
  pre-release-check:
    name: å‘å¸ƒå‰æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯æ ‡ç­¾æ ¼å¼
        run: |
          if [[ ! "${{ github.ref_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "[ERROR] æ ‡ç­¾æ ¼å¼ä¸æ­£ç¡®ï¼åº”è¯¥æ˜¯ v*.*.*"
            exit 1
          fi
          echo "[SUCCESS] æ ‡ç­¾æ ¼å¼æ­£ç¡®: ${{ github.ref_name }}"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œä»£ç æ£€æŸ¥
        run: npm run lint

      - name: æ„å»ºæ£€æŸ¥
        run: npm run build

  # Tauri æ„å»ºå’Œå‘å¸ƒ
  build-tauri:
    name: æ„å»º Tauri åº”ç”¨
    needs: pre-release-check
    strategy:
      fail-fast: false
      matrix:
        include:
          # - platform: 'macos-latest'
          #   args: '--target aarch64-apple-darwin'
          #   arch: 'aarch64'
          # - platform: 'macos-latest' 
          #   args: '--target x86_64-apple-darwin'
          #   arch: 'x86_64'
          # - platform: 'ubuntu-22.04'
          #   args: ''
          #   arch: 'x86_64'
          - platform: 'windows-latest'
            args: ''
            arch: 'x86_64'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£… Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v3

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: npm ci

      - name: æ„å»º Python Sidecar
        env:
          TAURI_TARGET_TRIPLE: ${{ matrix.platform == 'macos-latest' && (matrix.arch == 'aarch64' && 'aarch64-apple-darwin' || 'x86_64-apple-darwin') || '' }}
        run: npm run build-python

      - name: æ„å»º Tauri åº”ç”¨
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          VITE_VML_LICENSE: ${{ secrets.VITE_VML_LICENSE }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'My Universe ${{ github.ref_name }}'
          releaseBody: |
            ğŸ‰ **My Universe ${{ github.ref_name }}** å‘å¸ƒï¼

            ## ğŸ“‹ æ›´æ–°å†…å®¹
            æŸ¥çœ‹ [æäº¤è®°å½•](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) äº†è§£è¯¦ç»†æ›´æ”¹ã€‚

            ---
            â¤ï¸ æ„Ÿè°¢ä½¿ç”¨ My Universeï¼å¦‚æœ‰é—®é¢˜è¯·æäº¤ [Issue](https://github.com/${{ github.repository }}/issues)
          releaseDraft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          includeUpdaterJson: true
          args: ${{ matrix.args }}

  # æ›´æ–° Gist æ¸…å•
  update-gist-manifest:
    name: æ›´æ–° Gist æ›´æ–°æ¸…å•
    needs: build-tauri
    runs-on: ubuntu-latest
    steps:
      - name: ä¸‹è½½ latest.json æ–‡ä»¶
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          # Tauri Action è‡ªåŠ¨ç”Ÿæˆ latest.json æ–‡ä»¶
          gh release download ${{ github.ref_name }} --repo $GH_REPO --pattern "latest.json" || echo "latest.json æ–‡ä»¶ä¸å­˜åœ¨"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "latest.json" ]; then
            echo "æ‰¾åˆ° latest.json æ–‡ä»¶:"
            cat latest.json
          else
            echo "æœªæ‰¾åˆ° latest.json æ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦åœ¨ tauri.conf.json ä¸­å¯ç”¨ updater é…ç½®"
            exit 1
          fi

      - name: æ›´æ–° Gist æ¸…å•æ–‡ä»¶
        uses: popsiclestick/gist-sync-action@v1.2.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gist_url: https://gist.github.com/yarnb-x/494fee5048e024f1f7c057d2d175de51
          gist_title: "latest.json"
          gist_description: "åº”ç”¨è‡ªåŠ¨æ›´æ–°æ¸…å•æ–‡ä»¶ - ç”± GitHub Actions è‡ªåŠ¨ç»´æŠ¤"
          github_file: latest.json

  # å‘å¸ƒå®Œæˆé€šçŸ¥
  post-release:
    name: å‘å¸ƒå®Œæˆ
    needs: [build-tauri, update-gist-manifest]
    runs-on: ubuntu-latest
    steps:
      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "[SUCCESS] ç‰ˆæœ¬ ${{ github.ref_name }} å‘å¸ƒæˆåŠŸï¼"
          echo "[INFO] æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° GitHub Releases"
          echo "[INFO] ä¸‹è½½é“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" 